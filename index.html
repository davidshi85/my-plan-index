<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2小时交通圈 - 从中山市古镇镇出发</title>

    <!-- 引入 Leaflet 地图库的 CSS 文件 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- 引入 Leaflet 地图库的 JavaScript 文件 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <style>
        /* 基本页面样式 */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        /* 地图容器样式 */
        #map {
            flex-grow: 1; /* 让地图占据剩余的所有空间 */
            width: 100%;
            border-bottom: 1px solid #ccc;
        }
        /* 顶部标题栏样式 */
        .header {
            background-color: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1001; /* 确保在地图上层 */
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .header p {
            margin: 5px 0 0;
            font-size: 14px;
            color: #666;
        }
        /* 加载提示样式 */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 18px;
            color: #333;
            z-index: 1002; /* 最高层级 */
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none; /* 默认隐藏 */
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>中山市古镇镇2小时交通圈</h1>
        <p>显示从“中山市古镇镇人民政府”出发，驾车2小时可到达的区域范围。</p>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- 加载提示 -->
    <div id="loader">正在计算交通圈...</div>

    <script>
        // --- 1. 初始化地图 ---
        // 设置地图中心点为中山市古镇镇人民政府的大致坐标
        const startPoint = [22.617, 113.193]; // 纬度, 经度
        const map = L.map('map').setView(startPoint, 9); // 设置视图中心和缩放级别

        // 添加一个瓦片图层 (这里使用高德地图的开放瓦片)
        L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: '地图数据 © <a href="https://www.amap.com/">高德地图</a>'
        }).addTo(map);

        // 在地图上添加一个标记，表示出发点
        L.marker(startPoint).addTo(map)
            .bindPopup("<b>出发点</b><br>中山市古镇镇人民政府")
            .openPopup();

        // --- 2. 获取并绘制交通圈 (Isochrone) ---
        const loader = document.getElementById('loader');

        async function getIsochrone() {
            // 显示加载提示
            loader.style.display = 'block';

            // OpenRouteService API 配置
            // 注意：这是一个公开的演示密钥，有使用限制。在生产环境中，请注册您自己的免费密钥。
            const apiKey = '5b3ce3597851110001cf6248ba2c5132352c421798544e39a37a6592';
            const apiUrl = 'https://api.openrouteservice.org/v2/isochrones/driving-car';

            // API 请求参数
            const requestBody = {
                // 坐标顺序为 [经度, 纬度]
                'locations': [[startPoint[1], startPoint[0]]],
                'range_type': 'time',
                // 时间范围，单位为秒 (2小时 = 2 * 60 * 60 = 7200秒)
                'range': [7200],
                'attributes': ['area', 'reachfactor'],
                'area_units': 'km'
            };

            try {
                // 发送 POST 请求
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json, application/geo+json, application/gpx+xml, img/png; charset=utf-t-8',
                        'Content-Type': 'application/json',
                        'Authorization': apiKey
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败，状态码: ${response.status}`);
                }

                const data = await response.json();

                // 检查返回的数据是否有效
                if (data.features && data.features.length > 0) {
                    // 创建 GeoJSON 图层来显示返回的多边形区域
                    const isochroneLayer = L.geoJSON(data, {
                        style: function() {
                            return {
                                color: '#007bff', // 边框颜色
                                weight: 2,       // 边框宽度
                                opacity: 0.8,    // 边框透明度
                                fillColor: '#007bff', // 填充颜色
                                fillOpacity: 0.3 // 填充透明度
                            };
                        }
                    }).addTo(map);

                    // 调整地图视野以适应交通圈范围
                    map.fitBounds(isochroneLayer.getBounds());
                } else {
                    alert("未能获取到有效的交通圈数据。");
                }

            } catch (error) {
                console.error('获取交通圈时出错:', error);
                alert('无法连接到路径规划服务，请检查网络连接或稍后再试。');
            } finally {
                // 隐藏加载提示
                loader.style.display = 'none';
            }
        }

        // 页面加载完成后，调用函数开始计算
        getIsochrone();
    </script>

</body>
</html>
